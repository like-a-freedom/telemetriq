# Minimal Caddyfile for the frontend app
# Purpose: serve SPA static assets with SPA fallback and minimal security headers required by WebCodecs / SharedArrayBuffer

{
    # Avoid automatic TLS provisioning in containerized/local environments
    auto_https off
}

:80 {
    # Enable runtime template substitution
    templates

    # Minimal headers required by the app
    header {
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Embedder-Policy "require-corp"
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), microphone=()"
        X-Content-Type-Options "nosniff"
    }

    # Serve dynamic robots.txt (uses SITE_URL from environment at runtime)
    handle_path /robots.txt {
        respond "{=text}# robots.txt â€” generated by Caddy templates\nUser-agent: *\nAllow: /\n\n# Sitemap\nSitemap: {env.SITE_URL}/sitemap.xml\n\n# Crawl-delay for respectful crawling\nCrawl-delay: 1\n\n# Block common non-SEO paths\nDisallow: /node_modules/\nDisallow: /*.js$\nDisallow: /*.ts$\nDisallow: /test-results/\nDisallow: /coverage/\n" 200
        header Content-Type "text/plain; charset=utf-8"
    }

    # Serve dynamic sitemap.xml (uses SITE_URL from environment at runtime)
    handle_path /sitemap.xml {
        respond "{=xml}<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n  <url>\n    <loc>{env.SITE_URL}/</loc>\n    <lastmod>{now}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.6</priority>\n  </url>\n  <url>\n    <loc>{env.SITE_URL}/preview</loc>\n    <lastmod>{now}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.6</priority>\n  </url>\n  <url>\n    <loc>{env.SITE_URL}/processing</loc>\n    <lastmod>{now}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.6</priority>\n  </url>\n  <url>\n    <loc>{env.SITE_URL}/result</loc>\n    <lastmod>{now}</lastmod>\n    <changefreq>weekly</changefreq>\n    <priority>0.6</priority>\n  </url>\n</urlset>" 200
        header Content-Type "application/xml; charset=utf-8"
    }

    # Serve runtime JS config so client code can read SITE_URL without rebuild
    handle_path /site-config.js {
        respond "{=js}window.__SITE_URL__ = \"{env.SITE_URL}\";" 200
        header Content-Type "application/javascript; charset=utf-8"
    }





    # Health check (simple OK response)
    handle_path /health {
        respond "OK" 200
    }

    # Serve frontend static files (SPA fallback)
    root * /usr/share/caddy
    file_server
    try_files {path} /index.html

    # Cache static assets aggressively
    @staticFiles path_regexp static .*\.(js|css|png|jpg|jpeg|gif|ico|svg|wasm)$
    header @staticFiles Cache-Control "public, max-age=31536000, immutable"
}
